# ai-flow configuration
# Environment variables are expanded: ${VAR_NAME}

server:
  port: 11811

linear:
  api_key: "${LINEAR_API_KEY}"
  team_key: "MAU"                     # Your Linear team key
  mode: "webhook"                     # "webhook" or "poll" (default: "webhook")
  webhook_secret: "${LINEAR_WEBHOOK_SECRET}"  # Required when mode is "webhook"
  # poll_interval: "30s"              # Required when mode is "poll" (min 10s)

# GitHub repo config is defined per issue description (not per project).
# Add YAML frontmatter to each Linear issue's description:
#   ---
#   github_repo: owner/repo
#   default_branch: main
#   ---

pipeline:
  # Stage 1: Plan — analyze issue and create implementation plan
  - name: "plan"
    linear_state: "Todo"              # Trigger when issue enters this state
    command: "claude"
    args: ["-p", "--model", "sonnet", "--dangerously-skip-permissions"]
    prompt_file: "prompts/plan.md"    # Path to prompt file (relative to config)
    next_state: "In Progress"         # Transition to on success
    timeout: 7200                     # Seconds (default: 3600)
    labels: ["auto"]                  # Only issues with this label
    creates_pr: true                  # Clone repo, run in it, create PR

  # Stage 2: Implement — write code on existing branch
  - name: "implement"
    linear_state: "In Progress"
    command: "opencode"
    args: ["run", "-m", "synthetic/hf:moonshotai/Kimi-K2.5"]
    prompt_file: "prompts/implement.md"
    next_state: "Testing"
    timeout: 7200
    labels: ["auto"]
    uses_branch: true                 # Checkout existing branch (no new PR)

  # Stage 3: Test — run tests on existing branch
  - name: "test"
    linear_state: "Testing"
    command: "opencode"
    args: ["run", "-m", "synthetic/hf:moonshotai/Kimi-K2.5"]
    prompt_file: "prompts/test.md"
    next_state: "Security Review"
    failure_state: "In Progress"      # On failure, go back to implementation
    timeout: 7200
    labels: ["auto"]
    uses_branch: true

  # Stage 4: Security — review code on existing branch
  - name: "security"
    linear_state: "Security Review"
    command: "opencode"
    args: ["run", "-m", "synthetic/hf:moonshotai/Kimi-K2.5"]
    prompt_file: "prompts/security.md"
    next_state: "Overall Review"
    failure_state: "In Progress"
    timeout: 7200
    labels: ["auto"]
    uses_branch: true

  # Stage 5: Review — final code review on existing branch
  - name: "review"
    linear_state: "Overall Review"
    command: "claude"
    args: ["-p", "--model", "sonnet", "--dangerously-skip-permissions"]
    prompt_file: "prompts/review.md"
    next_state: "Done"
    failure_state: "In Progress"
    timeout: 7200
    labels: ["auto"]
    uses_branch: true

subprocess:
  context_mode: "env"                 # "env" | "stdin" | "both"
  max_concurrent: 3                   # Max parallel subprocess runs

# Persistent workspace directories (optional).
# When set, repos are cloned once and reused across pipeline stages
# instead of creating ephemeral temp directories each time.
# Structure: <root>/<owner>/<repo>/<branch>/
# Workspaces are cleaned up when issues reach "Done" state.
workspace:
  root: "${HOME}/ai-flow-workspaces"
